library(tidyverse)
library(readxl)
library(betapart)
library(sf)
library(viridis)

#load data
load(file = "output/OTU_maximum_distance.rda")
load(file = "output/otu_table.rda")
samps <- read_delim("input/Endemism_Table.txt", delim = "\t")
load(file = "output/plot_to_superregion_classification.rda")
eco <- plot_classification
st_geometry(eco) <- NULL
load(file = "output/super_ecoregions.rda")

# prepare super_ecoregions
super_reg <- super_regions %>%
  group_by(super_region)%>%
  bind_cols(st_centroid(.) %>%  st_coordinates() %>%  as_tibble()) %>%
  rename(centroid_X = 'X', centroid_Y =  "Y")

# something is odd with the labels here, trying to fix
dat <- otu_table %>%
  # only retain one instance per OTU per ecoregion
  distinct(otu, geo_superregion, .keep_all = TRUE) %>%
  mutate(value = 1)

# get OTUS only within a single region ("endemics")
list_endemic_OTUS <-
  dat %>%
  select(otu, geo_superregion) %>%
  mutate(value = 1) %>%
  group_by(otu) %>%
  summarize(endemic_to_single_region = sum(value)) %>%
  filter(endemic_to_single_region == 1)

dat <- dat %>%
  mutate(endemic_to_single_region = ifelse(otu %in% list_endemic_OTUS$otu, 1, 0))

# loop over all the relevant fungal groups and functional traits
li <- c("trt_primary_lifestyle_ectomycorrhizal",
        "trt_primary_lifestyle_arbuscular_mycorrhizal",
        "trt_Growth_form_yeast",
        "trt_Decay_type_mold",
        "trt_Agaricomycetes_NM",
        "trt_Pathogen",
        "trt_Unicellular",
        "trt_Opp_human_path"
        )

out <- list()

for(i in 1:length(li)){
  print(i)
  # create subset
  sub <- dat %>% filter(.data[[li[[i]]]] == 1)

  # calculate Crisp, only OTUS not endemic!
  crisp <- sub %>%
    select(otu, geo_superregion) %>%
    distinct() %>%
    left_join(max_dist) %>%
    group_by(geo_superregion) %>%
    filter(!is.na(max_distance)) %>%
    summarize(crisp_mean_max_dist = mean(max_distance))

  # calculate the proportion of endemics
  prop_end <- sub %>%
    group_by(geo_superregion) %>%
    summarize(
      n_endemic_OTU = sum(endemic_to_single_region[endemic_to_single_region == 1]),
      n_OTU = sum(value))%>%
    mutate(prop_endemic = n_endemic_OTU / n_OTU * 100)

  out_sub <- crisp %>%
    full_join(prop_end, by = "geo_superregion")

  # plot
  super_eco <- full_join(super_reg, out_sub, by = c("super_region" = "geo_superregion"))

  plo1 <- ggplot()+
    geom_sf(data = super_eco,
            aes(fill = crisp_mean_max_dist,
                color =  crisp_mean_max_dist))+
    scale_fill_viridis()+
    scale_colour_viridis()+
    ggtitle(paste(li[i], "Mean maximum distance", sep = " - "))+
    theme_bw()

  plo2 <- ggplot()+
    geom_sf(data = super_eco,
            aes(fill = prop_endemic,
                color =  prop_endemic))+
    scale_fill_viridis()+
    scale_colour_viridis()+
    ggtitle(paste(li[i], "Proportion endemics", sep = " - "))+
    theme_bw()

  pdf(paste("output/",
            li[i],
            ".pdf",
            sep = ""),
      width = 11, height = 8)
  print(plo1)
  print(plo2)
  dev.off()

  # return  data
  names(out_sub) <- c("geo_superregion",
                      paste(li[[i]], "_", "mean_max_dist", sep = ""),
                      paste(li[[i]], "_", "n_endemic_OTU", sep = ""),
                      paste(li[[i]], "_", "n_OTU", sep = ""),
                      paste(li[[i]], "_", "prop_endemic", sep = ""))

  out[[i]] <- out_sub
}

# save overall table
metrics <- full_join(out[[1]],
                     out[[2]]) %>%
  full_join(out[[3]]) %>%
  full_join(out[[4]]) %>%
  full_join(out[[5]]) %>%
  full_join(out[[6]]) %>%
  full_join(out[[7]]) %>%
  full_join(out[[8]])

write_csv(metrics, file = "output/mean_distance_and_proportion_endemism.csv")

