library(sf)
library(tidyverse)
library(readxl)
library(rnaturalearth)

# load data
poly <- st_read(dsn = "input", layer = "wwf_terr_ecos") %>%
  mutate(ECO_NAME = gsub("−", "-", ECO_NAME))%>%
  mutate(ECO_NAME = gsub("-", "-", ECO_NAME))

sups_in <-  read_xlsx("input/analysis_superecoregions_feb10.xlsx")
sups <- sups_in %>%
  dplyr::select(-Commentary) %>%
  pivot_longer(contains("Ecoregion", ignore.case = FALSE)) %>%
  filter(!is.na(value)) %>%
  dplyr::select(super_region = Superecoregion, ECO_NAME = value)

# check if any of the superecoregions are not in the poly file
sups$ECO_NAME[!sups$ECO_NAME %in% poly$ECO_NAME]
## here a replacement of one special character in the excel file was necessary (em dash by hyphen)

# merge super-region info in
poly <- poly %>%
  left_join(sups)

# merges
## Iceland
poly[poly$OBJECTID %in% c(4804, 5103, 5107, 5111, 5234),]$super_region <-  "Iceland boreal birch forests and alpine tundra"

# Svalbard, seems fine!
sub <- poly %>% filter(super_region == "Svalbard Arctic desert")
sva <- sub%>%
  st_crop(xmin = 0, xmax = 40, ymin = 74, ymax = 82)%>%
  mutate(super_region = "Svalbard Arctic desert") %>%
  mutate(ECO_NAME = "not_defined")

oth1 <- sub%>%
  st_crop(xmin = 40, xmax = 120, ymin = 0, ymax = 82)%>%
  mutate(super_region = "not_defined") %>%
  mutate(ECO_NAME = "not_defined")

oth2<- sub%>%
  st_crop(xmin = -20, xmax = 40, ymin = 0, ymax = 74)%>%
  mutate(super_region = "not_defined") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% sub$OBJECTID)
poly <- bind_rows(poly, sva, oth1, oth2)

#Anatollian forest
poly[poly$OBJECTID == 7822,]$super_region <-  "Anatolian forests"
poly[poly$OBJECTID == 7920,]$super_region <-  "Anatolian forests"

# Greenland
poly[poly$OBJECTID == 3680,]$super_region <-  "not_defined"

# make polygon valid
poly <- st_make_valid(poly)

#Greater Antilles
sel <- st_read(dsn = "output", layer = "greater_antilles_select")
sel <- st_intersection(poly, sel) %>%
  mutate(super_region = "Greater Antilles") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% sel$OBJECTID)
# poly <- poly %>%st_difference(sel)
poly <- bind_rows(poly, sel)

# Yucantan forest
sel <- st_read(dsn = "output", layer = "yucatan_forest") %>%
  mutate(super_region = "Yucatan forests") %>%
  mutate(ECO_NAME = "not_defined")

sel2 <- poly %>% filter(super_region == "Yucatan forests")

poly <- poly %>%
  filter(!OBJECTID %in% sel2$OBJECTID) %>%
  filter(!OBJECTID %in% sel$OBJECTID) %>%
  bind_rows(sel)

# CUba
sel <- st_read(dsn = "output", layer = "cuba_select")
sel <- st_intersection(poly, sel) %>%
  mutate(super_region = "Cuba forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% sel$OBJECTID)

#poly <- poly %>%st_difference(sel)

poly <- bind_rows(poly, sel)

# Lesser Antilles
sel <- st_read(dsn = "output", layer = "lesser_antilles_select")
sel <- st_intersection(poly, sel) %>%
  mutate(super_region = "Lesser Antilles forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% sel$OBJECTID)
poly <- bind_rows(poly, sel)

# cuts
#Southern Anatolian montane conifer and deciduous forests
t <- st_read(dsn = "input/ecoregions_split", layer = "anatolian_forests") %>%
  mutate(super_region = "Anatolian forests") %>%
  mutate(ECO_NAME = "not_defined")

add <- poly %>%
  filter(ECO_NAME == "Southern Anatolian montane conifer and deciduous forests") %>%
  st_crop(ymin = 33, ymax = 36, xmax = 38, xmin = 34) %>%
  mutate(super_region = "East Asian drylands") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>%  filter(ECO_NAME != "Southern Anatolian montane conifer and deciduous forests")
poly <- bind_rows(poly, t, add)

# remove the balkan part
sel <- read_xlsx("input/selection_balkan_forest.xlsx")
poly[poly$OBJECTID %in% sel$objectID,]$super_region <-  "Balkan forests"

t2 <- st_read(dsn = "input/ecoregions_split", layer = "e_asian_drylands") %>%
  mutate(super_region = "East Asian drylands") %>%
  mutate(ECO_NAME = "not_defined")
poly <- bind_rows(poly, t2)

#Colombia N forests
t <- st_read(dsn = "input/ecoregions_split", layer = "columbia_n_forests") %>%
  mutate(super_region = "Colombia N forests") %>%
  mutate(ECO_NAME = "not_defined")
poly <- poly %>%  filter(ECO_NAME != "Amazon-Orinoco-Southern Caribbean mangroves")
poly <- bind_rows(poly, t)

#Central African mangroves
t1 <- st_read(dsn = "input/ecoregions_split", layer = "e_guinean_forests") %>%
  mutate(super_region = "East Guinean forests") %>%
  mutate(ECO_NAME = "not_defined")
poly <- poly %>%  filter(ECO_NAME != "Central African mangroves")
poly <- bind_rows(poly, t1)

t2 <- st_read(dsn = "input/ecoregions_split", layer = "w_congolian_forests") %>%
  mutate(super_region = "Western Congolian forests") %>%
  mutate(ECO_NAME = "not_defined")
poly <- bind_rows(poly, t2)

#East African mangroves
poly <- poly %>%  filter(ECO_NAME != "East African mangroves")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "east_african_woodlands") %>%
  mutate(super_region = "East African woodlands") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "n_zanzibar_ihambane_coastal_f_mosaic") %>%
  mutate(super_region = "Northern Zanzibar-Inhambane coastal forest mosaic") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

#East Sudanian savanna
poly <- poly %>%  filter(ECO_NAME != "East Sudanian savanna")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "east_african_shrublands") %>%
  mutate(super_region = "East African shrublands") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "east_sudanian_savannah") %>%
  mutate(super_region = "East Sudanian savannas") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

#Guinean forest-savanna mosaic
poly <- poly %>%  filter(ECO_NAME != "Guinean forest-savanna mosaic")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "e_guinean_forests") %>%
  mutate(super_region = "East Guinean forests") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "west_guinean_forests") %>%
  mutate(super_region = "West Guinean forests") %>%
  mutate(ECO_NAME = "not_defined")

t3 <- st_read(dsn = "input/ecoregions_split", layer = "east_guinean_forest") %>%
  mutate(super_region = "East Guinean forests") %>%
  mutate(ECO_NAME = "not_defined")
st_crs(t3) <- st_crs(poly)
t3 <- st_make_valid(t3)

poly <- bind_rows(poly, t1, t2, t3)

#Monte Alegre varzeá
poly <- poly %>%  filter(ECO_NAME != "Monte Alegre varzeá")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "north_amazon_forests") %>%
  mutate(super_region = "North Amazon forests") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "west_amazon_forests") %>%
  mutate(super_region = "West Amazon forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

#Myanmar Coast mangroves
poly <- poly %>%  filter(ECO_NAME != "Myanmar Coast mangrovesá")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "burman_forests") %>%
  mutate(super_region = "Burman forests") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "tenasserim_south_thailand_fevergreen_rforests") %>%
  mutate(super_region = "Tenasserim-South Thailand semi-evergreen rain forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

#South American Pacific mangroves
poly <- poly %>%  filter(ECO_NAME != "South American Pacific mangroves")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "columbia_sw_forests") %>%
  mutate(super_region = "Colombia SW dry forests") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "columbia_w_forests") %>%
  mutate(super_region = "Colombia W forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

#Southern Atlantic mangroves
poly <- poly %>%  filter(ECO_NAME != "Southern Atlantic mangroves")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "Central_atlantic_rain_forests") %>% # wait for sandeep to also send this file
  mutate(super_region = "Central Atlantic rain forests") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "North_atlantic_rain_forests") %>%
  mutate(super_region = "North Atlantic rain forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

#West Sudanian savanna
poly <- poly %>%  filter(ECO_NAME != "West Sudanian savanna")

t1 <- st_read(dsn = "input/ecoregions_split", layer = "central_sudanian_savannah") %>%
  mutate(super_region = "Central Sudanian savanna") %>%
  mutate(ECO_NAME = "not_defined")

t2 <- st_read(dsn = "input/ecoregions_split", layer = "west_sudanian_savannah") %>%
  mutate(super_region = "West Sudanian savanna") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, t1, t2)

# ggplot()+
#   geom_sf(data = poly %>% filter(super_region == "Central Sudanian savanna"), color = "blue")+
#   geom_sf(data = poly %>% filter(super_region == "West Sudanian savanna"), color = "green")+
#   geom_sf(data = t1, color = "red")+
#   geom_sf(data = t2, color = "yellow")

## Scandinavian and Russian taiga
# get individual regions
t1 <- poly %>% filter(super_region == "Scandinavian and Russian taiga")
t2 <- poly %>% filter(ECO_NAME == "Scandinavian and Russian taiga")
count <- ne_countries(country = 'finland', scale = 'medium', returnclass = "sf")
st_write(count, dsn = "output", layer = "finland", driver = "ESRI Shapefile")

count2 <- ne_countries(country = c('sweden', 'norway'), scale = 'medium', returnclass = "sf")
st_write(count2, dsn = "output", layer = "sweden_norway", driver = "ESRI Shapefile")

# cut as remarked in LEhos table
sub <- poly %>% filter(ECO_NAME == "Scandinavian and Russian taiga")
poly <- poly %>% filter(ECO_NAME != "Scandinavian and Russian taiga")

st_write(sub, dsn = "output", layer = "aiga", driver = "ESRI Shapefile")
#cut
sel <- st_read(dsn = "output", layer = "finland_selection")#hand drawn in QGIS
sel2 <- st_read(dsn = "output", layer = "scandinavidan_selection")#hand drawn in QGIS
st_crs(sel2) <- st_crs(sub)

add1 <- st_intersection(sub, sel) %>%
  st_difference(sel2) %>%
  mutate(super_region = "Finland taiga") %>%
  mutate(ECO_NAME = "not_defined")
add1 <- st_make_valid(add1)

add2 <- st_intersection(sub, sel2) %>%
  mutate(super_region = "Scandinavian taiga") %>%
  mutate(ECO_NAME = "not_defined")

add3 <- st_read(dsn = "output", layer = "russian_taiga")%>%
  mutate(super_region = "Russian taiga") %>%
  mutate(ECO_NAME = "not_defined")
add3 <- st_make_valid(add3)

poly <- bind_rows(poly, add1, add2, add3)

# sarmantic mixed forest
t2 <- poly %>% select(OBJECTID, ECO_NAME) %>%  filter(ECO_NAME == "Sarmatic mixed forests")
count1 <- ne_countries(country = c('finland', "sweden", "norway"), scale = 'medium', returnclass = "sf")
count2 <- ne_countries(country = c('latvia'), scale = 'medium', returnclass = "sf")
count3 <- ne_countries(country = c('estonia'), scale = 'medium', returnclass = "sf")
count4 <- ne_countries(country = c('russia', "belarus"), scale = 'medium', returnclass = "sf")

st_write(t2, dsn = "output", layer = "sarmantic4", driver = "ESRI Shapefile")
st_write(count1, dsn = "output", layer = "sarmantic_scand", driver = "ESRI Shapefile")
st_write(count2, dsn = "output", layer = "sarmantic_latv", driver = "ESRI Shapefile")
st_write(count3, dsn = "output", layer = "sarmantic_esto", driver = "ESRI Shapefile")
st_write(count4, dsn = "output", layer = "sarmantic_su-bela", driver = "ESRI Shapefile")

sub <- poly %>% filter(ECO_NAME == "Sarmatic mixed forests")
poly <- poly %>% filter(ECO_NAME != "Sarmatic mixed forests")

# do intersection in QGIS and load results here
add1 <- st_read(dsn = "output", layer = "sarmantic_forest_scandinavia_clipped")%>%
  mutate(super_region = "Scandinavian Sarmatic mixed forests") %>%
  mutate(ECO_NAME = "not_defined")
st_crs(add1) <- st_crs(sub)


add2<- st_read(dsn = "output", layer = "sarmantic_forest_estonia_clipped")%>%
  mutate(super_region = "Estonian Sarmatic mixed forests") %>%
  mutate(ECO_NAME = "not_defined")
st_crs(add2) <- st_crs(sub)

add3 <- st_read(dsn = "output", layer = "sarmantic_forest_latvia_clipped")%>%
  mutate(super_region = "Latvian Sarmatic mixed forests") %>%
  mutate(ECO_NAME = "not_defined")
st_crs(add3) <- st_crs(sub)


add4 <- st_read(dsn = "output", layer = "sarmantic_forest_russia_clipped")%>%
  mutate(super_region = "Russian Sarmatic mixed forests") %>%
  mutate(ECO_NAME = "not_defined")
st_crs(add4) <- st_crs(sub)

poly <- bind_rows(poly, add1, add2, add3, add4)

# Alantic mixed forest
t1 <- poly %>% filter(super_region == "Atlantic mixed forests")
t2 <- poly %>% filter(ECO_NAME == "Atlantic mixed forests")

count <- ne_countries(country = c('france'), scale = 'medium', returnclass = "sf")
st_write(count, dsn = "output", layer = "france", driver = "ESRI Shapefile")
# cut as remarked in LEhos table
sub <- poly %>% filter(ECO_NAME == "Atlantic mixed forests")
poly <- poly %>% filter(ECO_NAME != "Atlantic mixed forests")

#cut
sel <- st_read(dsn = "output", layer = "france_selection")#hand drawn in QGIS
add1 <- st_intersection(sub, sel) %>%
  mutate(super_region = "France Atlantic mixed forests") %>%
  mutate(ECO_NAME = "not_defined")

add2 <- st_difference(sub, sel) %>%
  mutate(super_region = "Benelux Atlantic mixed forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly,add1, add2)

#Central EUropean mixed forest
t1 <- poly %>% filter(super_region == "Central European mixed forests")
t2 <- poly %>% filter(ECO_NAME == "Central European mixed forests")

count1 <- ne_countries(country = c('czech republic'), scale = 'medium', returnclass = "sf")

# cut as remarked in LEhos table
sub <- poly %>% filter(ECO_NAME == "Central European mixed forests")
poly <- poly %>% filter(ECO_NAME != "Central European mixed forests")

#cut
add1 <- st_intersection(sub, count1) %>%
  mutate(super_region = "Czech mixed forests") %>%
  mutate(ECO_NAME = "not_defined")

add2 <- st_difference(sub, count1) %>%
  mutate(super_region = "Central European mixed forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, add1, add2, add3)

#appennine forest
t1 <- poly %>% filter(super_region == "Appennine forests")
t2 <- poly %>% filter(ECO_NAME == "Tyrrhenian-Adriatic Sclerophyllous and mixed forests")

st_write(t2 %>% select(OBJECTID), dsn = "output", layer = "appenine_forest_to_be_cut", driver = "ESRI Shapefile")

sub <- poly %>% filter(ECO_NAME == "Tyrrhenian-Adriatic Sclerophyllous and mixed forests")
poly <- poly %>% filter(ECO_NAME != "Tyrrhenian-Adriatic Sclerophyllous and mixed forests")

cro <- st_read(dsn = "output", layer = "croatia_select")#hand drawn in QGIS
main_i <- st_read(dsn = "output", layer = "mainland_italy_select")
sard <- st_read(dsn = "output", layer = "sardengna_select")
sic <- st_read(dsn = "output", layer = "sicilly_select")
pant <- st_read(dsn = "output", layer = "pantelleria_select")


add1 <- st_intersection(sub, cro) %>%
  mutate(super_region = "Balkan forests") %>%
  mutate(ECO_NAME = "not_defined")

add2 <- st_intersection(sub, main_i) %>%
  mutate(super_region = "Appennine forests") %>%
  mutate(ECO_NAME = "not_defined")

add3 <- st_intersection(sub, sard) %>%
  mutate(super_region = "Sardinian−Corsican forests") %>%
  mutate(ECO_NAME = "not_defined")

add4 <- st_intersection(sub, sic) %>%
  mutate(super_region = "Sicilian forests") %>%
  mutate(ECO_NAME = "not_defined")

add5 <- st_intersection(sub, pant) %>%
  mutate(super_region = "Pantelleria−Lampedusa forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, add1, add2, add3, add4, add5)

# additional changes for corsica and sicilly
poly[poly$OBJECTID == 7592,]$super_region <-  "Sardinian−Corsican forests"
poly[poly$OBJECTID == 7865,]$super_region <-  "Sicilian forests"

# Spain and portugal woodlands
#t1 <- poly %>% filter(super_region == "Spain and Portugal woodlands")
# sel1 <- poly %>% filter(super_region == "Spain woodlands")
# poly <- poly %>% filter(!OBJECTID %in% sel1$OBJECTID)
# sel2 <- poly %>% filter(super_region == "Portugal woodlands")
# poly <- poly %>% filter(!OBJECTID %in% sel2$OBJECTID)

count <- ne_countries(country = c('portugal'), scale = 'medium', returnclass = "sf")

st_write(count, dsn = "output", layer = "portugal", driver = "ESRI Shapefile")
sel <- st_read(dsn = "output", layer = "portugal_selection")#hand drawn in QGIS

sub <- poly %>% filter(ECO_NAME %in% c("Northeastern Spain and Southern France Mediterranean forests",
                                       "Iberian conifer forests",
                                       "Iberian sclerophyllous and semi-deciduous forests",
                                       "Cantabrian mixed forests",
                                       "Northwest Iberian montane forests",
                                       "Southwest Iberian Mediterranean sclerophyllous and mixed forests",
                                       "Southeastern Iberian shrubs and woodlands"))

poly <- poly %>% filter(!ECO_NAME %in% c("Northeastern Spain and Southern France Mediterranean forests",
                                        "Iberian conifer forests",
                                        "Iberian sclerophyllous and semi-deciduous forests",
                                        "Cantabrian mixed forests",
                                        "Northwest Iberian montane forests",
                                        "Southwest Iberian Mediterranean sclerophyllous and mixed forests",
                                        "Southeastern Iberian shrubs and woodlands"))

add1 <- st_intersection(sub, sel) %>%
  mutate(super_region = "Portugal woodlands") %>%
  mutate(ECO_NAME = "not_defined")

add2 <- st_difference(sub, sel) %>%
  mutate(super_region = "Spain woodlands") %>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, add1, add2)

# Ural - remove the duplicated URal region related to the Russian taige
poly <- poly %>% filter(!(ECO_NAME =="Ural montane forests and tundra" & super_region =="Russian taiga"))

# Queen Charlotte Islands
poly <- poly %>% mutate(super_region = ifelse(ECO_NAME == "Queen Charlotte Islands", "USA−Canada Pacific forests and grasslands", super_region))

#Alaska Tundra
poly <- poly %>% mutate(super_region = ifelse(ECO_NAME %in% c("Interior Yukon−Alaska alpine tundra", "Ogilvie−MacKenzie alpine tundra"), "Alaskan tundra", super_region))

#Canadian tundra - remove
poly <- poly %>% mutate(super_region = ifelse(super_region == "Canadian tundra", NA, super_region))

# "Granitic Seychelles forests - remove
poly <- poly %>% mutate(super_region = ifelse(super_region == "Granitic Seychelles forests", NA, super_region))

#Islands in front of Venezualean cost
sel <- st_read(dsn = "output", layer = "venezuelean_islands_selection")#hand drawn in QGIS

add <- st_intersection(poly, sel)%>%
  mutate(super_region = "Colombia N forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% add$OBJECTID)

poly <- bind_rows(poly, add)

#philippines
sel <- st_read(dsn = "output", layer = "philippines_selection")#hand drawn in QGIS

add <- st_intersection(poly, sel)%>%
  mutate(super_region = "Philippines forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% add$OBJECTID)

poly <- bind_rows(poly, add)

#SUmatra
sel <- st_read(dsn = "output", layer = "sumatra_selection")#hand drawn in QGIS

add <- st_intersection(poly, sel)%>%
  mutate(super_region = "Sumatran forests") %>%
  mutate(ECO_NAME = "not_defined")

poly <- poly %>% filter(!OBJECTID %in% add$OBJECTID)

poly <- bind_rows(poly, add)

#East African woodlands
st_write(poly  %>% filter(super_region == "East African woodlands") %>%  select(OBJECTID),
         dsn = "output",
         layer = "east_africa_woodlands_to_be_cut",
         driver = "ESRI Shapefile")

sel1 <- poly %>%  filter(super_region == "East African woodlands")
poly <- poly %>%  filter(!OBJECTID %in% sel1$OBJECTID)

north <- st_read(dsn = "output", layer = "East_African_woodlands_north_new")%>%
  mutate(super_region = "East African woodlands") %>%
  mutate(ECO_NAME = "not_defined")

south <- st_read(dsn = "output", layer = "ea_south_new") %>%
  mutate(super_region = "Zimbabwe-Mozambique woodlands")%>%
  mutate(ECO_NAME = "not_defined")

poly <- bind_rows(poly, north, south)

# ggplot()+
#   geom_sf(data = poly %>% filter(super_region == "East African woodlands"), color = "green")+
#   geom_sf(data = north, color = "green")+
#   geom_sf(data = south, color = "blue")

poly %>% filter(super_region == "East African woodlands")

#East Guinean forests
poly[poly$OBJECTID %in% c(10460, 10402, 10352, 10367, 10234),]$super_region <-  "East Guinean forests"

#colombian island
poly[poly$OBJECTID == 1304,]$super_region <-  "Colombia N forests"

# more illyrian forests
poly <- poly %>% mutate(super_region =
                          ifelse(ECO_NAME == "Illyrian deciduous forests",
                                 "Balkan forests",
                                 super_region ))

#Burma mangroves
poly <- poly %>% mutate(super_region = ifelse(ECO_NAME == "Myanmar Coast mangroves",
                                              "Burman forests",
                                              super_region ))

#Victoria Basin forest−savanna mosaic
poly[poly$OBJECTID == 10795,]$super_region <-  "Ethiopian montane woodlands"

#########################################
# Final checks
########################################
# check for duplicated IDs
sum(duplicated(poly$OBJECTID))

View(poly[poly$OBJECTID %in% dup,])

dup <- poly$OBJECTID[duplicated(poly$OBJECTID)]

out <- list()
k <- 1
for(i in 1:length(dup)){
  sub <- poly %>% filter(OBJECTID == dup[i])
  sub <- sub %>% filter(!is.na(super_region))
  if(length(unique(sub$super_region)) > 1){
    out[[k]] <- sub$super_region
    k <- k+1
  }
}
# these are duplications that stem from splitting the polygons. That is fine.

#check for spelling problems
sort(unique(poly$super_region))

# Identify not defined ecoregions
poly <- poly %>% mutate(super_region = ifelse(is.na(super_region), "not_defined", super_region))

nrow(poly %>% filter(super_region == "not_defined"))

#prepare output
poly <- poly %>%  select(OBJECTID:super_region)
#test validity
sum(!st_is_valid(poly))
poly <- st_make_valid(poly)

save(poly, file = "output/adapted_wwf_shapefiles_with_super_region_attribute.rda")

# Union polygons
nd <- poly %>% filter(super_region == "not_defined")
poly <- poly %>% filter(super_region != "not_defined")

li <- unique(poly$super_region)
uni_out <- list()

for(i in 1:length(li)){
  print(i)
  print(li[i])
  sub <- poly %>% filter(super_region == li[i])

  uni_out[[i]] <- st_sf(data.frame(super_region = unique(sub$super_region),
                                   Area = sum(sub$AREA)),
                        geom = st_union(sub))

}

super_regions <- bind_rows(uni_out)


nd_out <- st_sf(data.frame(super_region = unique(nd$super_region),
                                 Area = sum(nd$AREA)),
                      geom = st_union(nd))

super_regions <- bind_rows(super_regions, nd_out)

# check validity
st_is_valid(super_regions)

# recalculate area to account for changed superregions
area <- super_regions %>%
  group_by(super_region) %>%
  st_area()

area <- tibble(super_region = super_regions$super_region,
               area = area / 1000000)

super_regions<- left_join(super_regions, area, by = "super_region") %>%
  select(-Area)

# write to disk
save(super_regions, file = "output/super_ecoregions.rda")
