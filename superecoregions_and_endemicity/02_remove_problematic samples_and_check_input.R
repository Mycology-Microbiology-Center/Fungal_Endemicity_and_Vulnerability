#libraries
library(tidyverse)
library(readxl)

# load data
otu <- read_delim("input/analysis_GSM_and_UNITE_for_Endemicity_May24.txt", delim = "\t")
loc <- read_xlsx("input/analysis_sample_to_area_classification_may04.xlsx")
otu_remove <-  read_xlsx("input/analysis_samples_to_remove_June06.xlsx")

# Remove samples to be removed from OTU table
# part of the samples are from ID part are from sample_name old, combine to join the datasets
loc <- loc %>%
  mutate(merger = ifelse(old_sample_name %in% otu$Sample, old_sample_name, ID)) %>%
  select(merger, exclusion, type_or_abundance, data_type, superregion_alex, ECO_NAME, REALM, BIOME, Y, X)

names(loc) <- paste("geo_", names(loc), sep = "")

# join both tables
otu_table <- otu %>%
  left_join(loc, by = c("Sample" = "geo_merger"))

# create output table
otu_table <- otu_table %>%
  # remove samples marked for exclusion
  filter(!Sample %in% otu_remove$sample_ID) %>%
  # remove plots marked for exclusion
  filter(is.na(geo_exclusion)) %>%
  #remove NA coordinates
  filter(!is.na(geo_X)) %>%
  filter(!is.na(geo_Y)) %>%
  # select relevant columns
  select(otu = OTU,
         sample_id = Sample,
         abundance = Abundance,
         tax_kingdom = Kingdom,
         tax_phylum = Phylum,
         tax_class = Class,
         tax_order = Order,
         tax_family = Family,
         tax_genus = Genus,
         tax_species = Species,
         geo_X,
         geo_Y,
         geo_superregion = geo_superregion_alex,
         geo_ECO_NAME,
         geo_BIOME,
         trt_primary_lifestyle_ectomycorrhizal = primary_lifestyle_ectomycorrhizal,
         trt_primary_lifestyle_arbuscular_mycorrhizal = primary_lifestyle_arbuscular_mycorrhizal,
         trt_Growth_form_yeast = Growth_form_yeast,
         trt_Decay_type_mold = Decay_type_mold,
         trt_Agaricomycetes_NM = Agaricomycetes_NM,
         trt_Pathogen = Pathogen,
         trt_Unicellular = Unicellular,
         trt_Opp_human_path = Opp_human_path)

# write to disk
save(otu_table, file = "output/otu_table.rda")

# now link OTUS with wsuper-region classification
unique(loc$old_sample_name)

unique(otu$Sample)

length(otu$Sample[otu$Sample %in% loc$old_sample_name])
length(otu$Sample[otu$Sample %in% loc$ID])

# check for NAs
sum(is.na(otu_table$LAT))
sum(is.na(otu_table$geo_Y))
otu_table %>% filter(is.na(geo_Y)) %>%  View()

sum(is.na(otu_table$LON))
sum(is.na(otu_table$geo_X))
otu_table %>% filter(is.na(geo_X)) %>%  View()
