library(tidyverse)
library(geosphere)

load(file = "output/otu_table.rda")

# maximum geographic distance
## get OTUs with more than one instance
mult <- table(otu_table$otu)
mult <- names(mult[mult > 1])

dat <- otu_table %>%
  select(otu, geo_Y, geo_X) %>%
  filter(otu %in% mult) %>%
  group_by(otu) %>%
  group_split()

get_max <- function(x){
  sub <- max(distm(x[,c("geo_X", "geo_Y")]))
  sub_out <- tibble(otu = unique(x$otu),
                    max_distance = sub)
 return(sub_out)
}

out <- purrr::map(dat, get_max)
max_dist <- bind_rows(out)

# write to disk
save(max_dist, file = "output/OTU_maximum_distance.rda")

#plot
ggplot()+
  geom_histogram(data = max_dist, aes(max_distance/1000), bins = 50)+
  ylab("Number of OTUs")+
  xlab("Maximum distance among occurrences [km]")+
  theme_bw()

ggsave(file = "output/04_plot_histogramm_max_OTU_distance.pdf")
