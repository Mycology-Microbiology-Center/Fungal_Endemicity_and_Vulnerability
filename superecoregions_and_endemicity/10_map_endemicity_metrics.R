# A script to visualize endemicity values in all the superecoregions
library(tidyverse)
library(sf)
library(readxl)

# load data
dat <- read_xlsx("input/Endemicity_map_24_02_2022.xlsx")
load(file = "output/super_ecoregions_results.rda")

# merge endemicity metrics with superecoregions,
plo_wide <- super_eco %>%
  select(super_region) %>%
  left_join(dat, by = c("super_region" = "geo_superregion"))

#check if all have matched
dim(super_eco)
dim(plo_wide)
sum(is.na(plo_wide$super_region))
sum(is.na(plo_wide$EcM_ENDave))

# separate "not defined" ecoregions (without records) from others
load(file = "output/super_region_without_sample.rda")
plo_wide  <- plo_wide  %>%
  mutate(super_region = ifelse(super_region %in% ser_with_no_sample$super_region, "not_defined", super_region))

#split of not defined regions
not_defined <- plo_wide  %>%  filter(super_region == "not_defined")
plo_wide <- plo_wide %>% filter(super_region != "not_defined")

# # convert to long format for grid plot
# plo <- plo_wide%>%
#   pivot_longer(contains("Std"), names_to = "functional_type", values_to = "value")

#plots
for(i in c(3:(ncol(plo_wide)))){
  print(i)
  pdf(paste("output/", "endemicity_functional_types_map_", names(plo_wide)[i], ".pdf", sep = ""),
      width = 11, height = 8)
  # tiff(paste("output/", "endemicity_functional_types_map_",
  #            names(plo_wide)[i], ".tiff", sep = ""),
  #      height = 6,
  #      width = 10,
  #      res = 2400,
  #      compression = "lzw",
  #      units = "in")
  out <- ggplot()+
    geom_sf(data = not_defined, fill = "grey", color = "black", size = 0.1)+
    geom_sf(data = plo_wide,
            aes_string(fill = names(plo_wide)[i],
                       color =  names(plo_wide)[i]),
            size = 0.1)+
    scale_fill_distiller(palette = "Spectral")+
    scale_color_distiller(palette = "Spectral") +
    # scale_color_gradient2(low = "blue", mid = "green", high = "red")+
    # scale_fill_gradient2(low = "blue", mid = "green", high = "red")+
    # scale_color_gradient2(low = "blue", mid = "white", high = "red")+
    # scale_fill_gradient2(low = "blue", mid = "white", high = "red")+
    ggtitle(names(plo_wide)[i])+
    theme_bw()+
    theme(legend.title = element_blank())
  print(out)
  dev.off()
}
#
#
# #plot old values
# dat <- read_xlsx("input/endemicity_superecoregions_for_mapping.xlsx", sheet = "old")
#
# # merge endemicity metrics with superecoregions,
# plo_wide <- super_eco %>%
#   select(super_region) %>%
#   left_join(dat, by = c("super_region" = "geo_superregion"))
#
# #check if all have matched
# dim(super_eco)
# dim(plo_wide)
# sum(is.na(plo_wide$super_region))
# sum(is.na(plo_wide$EcM_ENDave))
#
# # convert to long format for grid plot
# #plots
# for(i in c(2:(ncol(plo_wide)))){
#   print(i)
#   pdf(paste("output/", "endemicity_functional_types_map_old", names(plo_wide)[i], ".pdf", sep = ""),
#       width = 11, height = 8)
#   # tiff(paste("output/", "endemicity_functional_types_map_",
#   #            names(plo_wide)[i], ".tiff", sep = ""),
#   #      height = 6,
#   #      width = 10,
#   #      res = 2400,
#   #      compression = "lzw",
#   #      units = "in")
#   out <- ggplot()+
#     geom_sf(data = plo_wide,
#             aes_string(fill = names(plo_wide)[i],
#                        color =  names(plo_wide)[i]),
#             size = 0.1)+
#     scale_fill_distiller(palette = "Spectral")+
#     scale_color_distiller(palette = "Spectral") +
#     # scale_color_gradient2(low = "blue", mid = "green", high = "red")+
#     # scale_fill_gradient2(low = "blue", mid = "green", high = "red")+
#     # scale_color_gradient2(low = "blue", mid = "white", high = "red")+
#     # scale_fill_gradient2(low = "blue", mid = "white", high = "red")+
#     ggtitle(names(plo_wide)[i])+
#     theme_bw()+
#     theme(legend.title = element_blank())
#   print(out)
#   dev.off()
# }
#
