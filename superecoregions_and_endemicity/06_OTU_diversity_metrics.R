library(tidyverse)
library(readxl)
library(betapart)
library(sf)

#load data
load(file = "output/OTU_maximum_distance.rda")
load(file = "output/otu_table.rda")

#samps <- read_delim("input/Endemism_Table.txt", delim = "\t")
load(file = "output/plot_to_superregion_classification.rda")
eco <- plot_classification
st_geometry(eco) <- NULL

# something is odd with the labels here, trying to fix
dat <- otu_table %>%
  # only retain one instance per OTU per ecoregion
  distinct(otu, geo_superregion, .keep_all = TRUE) %>%
  mutate(value = 1)

# get OTUS only within a single region ("endemics")
list_endemic_OTUS <-
  dat %>%
  select(otu, geo_superregion) %>%
  mutate(value = 1) %>%
  group_by(otu) %>%
  summarize(endemic_to_single_region = sum(value)) %>%
  filter(endemic_to_single_region == 1)

dat <- dat %>%
  mutate(endemic_to_single_region = ifelse(otu %in% list_endemic_OTUS$otu, 1, 0))

out <- dat %>%
  group_by(geo_superregion) %>%
  summarize(n_OTU = sum(value),
            n_ectomyc = sum(trt_primary_lifestyle_ectomycorrhizal),
            n_arbuscmyc = sum(trt_primary_lifestyle_arbuscular_mycorrhizal),
            n_gfyeast = sum(trt_Growth_form_yeast),
            n_dtmold = sum(trt_Decay_type_mold),
            n_agaricomyc = sum(trt_Agaricomycetes_NM),
            n_patho = sum(trt_Pathogen),
            n_unicel = sum(trt_Unicellular),
            n_opphumpat = sum(trt_Opp_human_path),
            n_endemic_OTU = sum(endemic_to_single_region[endemic_to_single_region == 1]),
            n_endemic_ectomyc = sum(trt_primary_lifestyle_ectomycorrhizal[endemic_to_single_region == 1]),
            n_endemic_ectomyc = sum(trt_primary_lifestyle_ectomycorrhizal[endemic_to_single_region == 1]),
            n_endemic_arbuscmyc = sum(trt_primary_lifestyle_arbuscular_mycorrhizal[endemic_to_single_region == 1]),
            n_endemic_gfyeast = sum(trt_Growth_form_yeast[endemic_to_single_region == 1]),
            n_endemic_dtmold = sum(trt_Decay_type_mold[endemic_to_single_region == 1]),
            n_endemic_agaricomyc = sum(trt_Agaricomycetes_NM[endemic_to_single_region == 1]),
            n_endemic_patho = sum(trt_Pathogen[endemic_to_single_region == 1]),
            n_endemic_unicel = sum(trt_Unicellular[endemic_to_single_region == 1]),
            n_endemic_opphumpat = sum(trt_Opp_human_path[endemic_to_single_region == 1])) %>%
  mutate(prop_endemic = n_endemic_OTU / n_OTU * 100)

#.Crisp's weighted endemicity metric for superecoregions, for now only based on species with more than one occurrence
crisp <- dat %>%
  select(otu, geo_superregion) %>%
  distinct() %>%
  right_join(max_dist) %>%
  group_by(geo_superregion) %>%
  summarize(crisp_mean_max_dist = mean(max_distance),
          crisp_median_max_dist = median(max_distance))

out <- out %>%
  left_join(crisp)

# pairwise Jaccard iand beta.sim index
baselga <- dat %>%
  select(otu, geo_superregion) %>%
  distinct() %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = geo_superregion, values_from = value)

baselga[is.na(baselga)] <- 0
nams <- baselga$OTU
baselga <- baselga[,-1]
baselga <- data.frame(t(baselga))
names(baselga) <- nams

save(baselga, file = "output/region_by_OTU_matrix.rda")

##########################################################################
#run on cluster for RAM reasons
# beta <- beta.pair(x = baselga, index.family = "jaccard")
#
# #jaccard total
# jac <- as.matrix(beta$beta.jac)
# diag(jac) <- NA
# jac <- data.frame(rowMeans(jac, na.rm = TRUE))
# jac$geo_superregion <- rownames(jac)
# names(jac) <- c("jac", "geo_superregion")
#
# #jaccard turnover
# jtu <- as.matrix(beta$beta.jtu)
# diag(jtu) <- NA
# jtu <- data.frame(rowMeans(jtu, na.rm = TRUE))
# jtu$geo_superregion <- rownames(jtu)
# names(jtu) <- c("jtu", "geo_superregion")
#
# jaccard <- jac %>%
#   left_join(jtu)
#
# save(jaccard, file = "jaccard.rda")

###########################################################################
load(file = "output/jaccard.rda")
diversity <- out %>%
  left_join(jaccard)

# write to disk
save(diversity, file = "output/diversity_metrics_per_superregion.rda")
write_csv(diversity, file = "output/diversity_indeces_all_otus.csv")
