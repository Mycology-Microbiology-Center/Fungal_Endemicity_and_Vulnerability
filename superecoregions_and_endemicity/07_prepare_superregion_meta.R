library(sf)
library(tidyverse)
library(readxl)
library(viridis)
library(geosphere)
library(writexl)

#load data
load(file = "output/super_ecoregions.rda")
load(file = "output/diversity_metrics_per_superregion.rda")
load(file = "output/otu_table.rda")

# prepare super_ecoregions
super_reg <- super_regions %>%
  group_by(super_region)%>%
  bind_cols(st_centroid(.) %>%  st_coordinates() %>%  as_tibble()) %>%
  rename(centroid_X = 'X', centroid_Y =  "Y")

# get minimum latitude values and latitudinal span
lat_span <- list()

for(i in 1:nrow(super_reg)){
  print(i)
  sub <- super_reg[i,] %>%
    st_coordinates() %>%
    as_tibble()
  out <- data.frame(super_region = super_reg[i,]$super_region,
                    minimum_lat = min(sub$Y),
                    maximum_lat = max(sub$Y),
                    mean_lon = mean(sub$X),
                    lat_span_deg = (max(sub$Y) + 90) - (min(sub$Y) + 90))
  out$lat_span_km <- distHaversine(c(out$mean_lon, out$minimum_lat),
                                   c(out$mean_lon, out$maximum_lat))/ 1000
  lat_span[[i]] <- out

}

lat_span <-  bind_rows(lat_span)

super_eco <- full_join(super_reg, lat_span) %>%
  full_join(diversity, by = c("super_region" = "geo_superregion"))

repl <- names(super_eco )[grepl("n_", names(out))]
repl2 <- as.list(rep(0, length(repl)))
names(repl2) <- repl

super_eco  <- super_eco  %>%
  replace_na(repl2)

# check if all regions are there
sum(is.na(super_eco$centroid_Y))
sum(is.na(super_eco$area)) #no records and removed in the script 01
sum(is.na(super_eco$n_OTU)) # these should be the regions without samples

super_eco %>% filter(is.na(area))

# check if all regions from the polygons are present
sum(!super_regions$super_region %in% super_eco$super_region)
sum(!otu_table$geo_superregion %in% super_eco$super_region)

save(super_eco, file = "output/super_ecoregions_results.rda")
write_xlsx(super_eco, path = "output/super_ecoregions_with_overall_diversity_indeces.xlsx")
