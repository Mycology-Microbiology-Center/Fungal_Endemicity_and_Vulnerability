#!/usr/bin/env Rscript

## Script to merge residuals into a single raster and create co-kriging map

## Usage:
# ./RasterModel_MergeResids_on_HPC.R \
#   --input "full__ConsExVxG_EcM"


############################################## Parse input parameters


## Check time
start_time <- Sys.time()


cat("Parsing input options and arguments...\n")

suppressPackageStartupMessages(require(optparse))

## Parse arguments
option_list <- list(
  make_option(c("-i", "--input"), action="store", default=NA, type='character', help="Model ID")
)
opt <- parse_args(OptionParser(option_list=option_list))



## Assign variables
MODEL <- opt$input

## Log assigned variables
cat(paste("Model: ", MODEL, "\n", sep=""))

cat("\n")


############################################## Load packages and data

cat("Loading R packages...\n")

load_pckg <- function(pkg = "data.table"){
  suppressPackageStartupMessages( library(package = pkg, character.only = TRUE) )
  cat(paste(pkg, packageVersion(pkg), "\n"))
}

load_pckg("raster")
load_pckg("data.table")
load_pckg("plyr")

cat("\n")



cat("Loading masks...\n")

## Load snow and ice mask
ICE <- readRDS("copern_Mask_Ice,Crop,Urb.RData")

## Load snow and ice raster
ICERST <- raster("copern_Mask_Ice,Crop,Urb.tif")



############################################## Main workflow


## Function to merge residuals, create co-kriging map, and plot the maps
make_cokrig_map <- function(rst, rzd, prefix = "Cons_yeast__"){
  # rst = raster with model-based predictions (e.g., rst <- "Cons_yeast__LT_LinearModel.tif")
  # rzd = folder with interpolated residuals

  ## Raster with model predictions
  cat("Loading model-based raster.\n")
  rst <- raster(rst)

  ## Files with interpolated residuals
  cat("Loading chunked residuals.\n")
  rzd <- list.files(
    path = rzd,
    pattern = "RData$", full.names = T)

  ## Load and merge residuals
  cat("Merging residuals.\n")
  rzdl <- alply(.data = rzd, .margins = 1,
    .fun = function(z){ readRDS(z) },
    .progress = "text")

  rzd <- rbindlist(rzdl)
  rm(rzdl); gc()

  ## Load model raster to RAM, for faster replacement
  cat("Loading model-based raster into RAM.\n")
  rst <- readAll(rst)

  ## Hide glaciated areas (snow and ice)
  cat("Removing glaciated areas from the model-based raster.\n")
  rst[ ICE$cell ] <- NA

  ## Replace cells in a raster with residuals
  cat("Preparing raster with residuals.\n")
  res <- rst
  res[ rzd$cell ] <- rzd$Residuals
  cat("Removing glaciated areas from the residuals raster.\n")
  res[ ICE$cell ] <- NA

  ## Predictions + Residuals
  cat("Creating final raster.\n")
  ok <- rst + res

  ## Export rasters to tif
  cat("Exporting rasters.\n")
  writeRaster(x = res,
    filename = paste0(prefix, "_Residuals_interpolated.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=7"))

  writeRaster(x = ok,
    filename = paste0(prefix, "_Cokriging_map.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=7"))

  rm(rst, res, ok, rzd)
  # removeTmpFiles(h=0.01)
  gc()

  cat("All done for ", prefix, "\n")
}


## Run main function
make_cokrig_map(
  rst = paste0("MODS/", MODEL, "__Model.tif"),
  rzd = MODEL,
  prefix = MODEL)



#####################

## Check time
end_time <- Sys.time()

tmm <- as.numeric(difftime(end_time, start_time, units = "min"))
cat("\nElapsed time: ", tmm, " minutes\n")


cat("\n")
cat("Session info:\n")
sessionInfo()
cat("\n")
