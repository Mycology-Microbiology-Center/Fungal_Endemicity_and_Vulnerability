#!/usr/bin/env Rscript

## Script to plot the vulnerability index (t2)

## Usage:
# ./Vulnerability_script_PlotT2_cokrig.R \
#    --model "ECM_bio5_none_gam__Current_t2_clipped.tif" \
#    --resids "./ECM_bio5_Current/" \
#    --snow "Copernicus_SnowIce.RData" \
#    --output


############################################## Parse input parameters

## Check time
start_time <- Sys.time()


cat("Parsing input options and arguments...\n")

suppressPackageStartupMessages(require(optparse)) # don't say "Loading required package: optparse"

## Parse arguments
option_list <- list(
  make_option(c("-m", "--model"), action="store", default=NA, type='character', help="Input tiff file with model predictions"),
  make_option(c("-r", "--resids"), action="store", default=NA, type='character', help="Folder with interpolated residuals chunks"),
  make_option(c("-s", "--snow"), action="store", default="Copernicus_SnowIce.RData", type='character', help="Data.table with ice and snow mask"),
  make_option(c("-o", "--output"), action="store", default=NA, type='character', help="Output prefix")
)
opt <- parse_args(OptionParser(option_list=option_list))


## Assign variables
MODEL_PREDICTIONS <- opt$model
INTERPOLATED_RESIDS_FLD <- opt$resids
SNOW <- opt$snow
OUTPUT <- opt$output

## Log assigned variables
cat(paste("Model-based vulnerability raster: ", MODEL_PREDICTIONS, "\n", sep=""))
cat(paste("Folder with interpolated residuals: ", INTERPOLATED_RESIDS_FLD, "\n", sep=""))
cat(paste("File with snow mask: ", SNOW, "\n", sep=""))
cat(paste("Output prefix: ", OUTPUT, "\n", sep=""))
cat("\n")

############################################## Load packages and data

cat("Loading packages...\n")

load_pckg <- function(pkg = "raster"){
  suppressPackageStartupMessages( library(package = pkg, character.only = TRUE) )
  cat(paste(pkg, packageVersion(pkg), "\n"))
}

load_pckg("data.table")
load_pckg("sp")
load_pckg("raster")
load_pckg("plyr")
load_pckg("colorspace")

cat("\n")


## Load snow and ice mask
cat("\nLoading snow mask..\n")
SNOW <- readRDS(SNOW)

############################################## Main function


## Function to create raster with interpolated residuals and adjusted vulnerability predictions
cokrig_maps <- function(MODEL_PREDICTIONS, INTERPOLATED_RESIDS_FLD, SNOW, OUTPUT = "Results"){ 
  # MODEL_PREDICTIONS = tif with model predictions (non-spatial)
  # INTERPOLATED_RESIDS_FLD = folder with interpolated residuals
  # SNOW = data.table with cell IDs of snow and ice
  # OUTPUT = output prefix

  ## Load raster with model predictions
  cat("\nLoading raster..\n")
  rst <- raster(MODEL_PREDICTIONS)

  ## Files with interpolated residuals
  rzd <- list.files(
    path = INTERPOLATED_RESIDS_FLD,
    pattern = "RData$", full.names = T)

  ## Load and merge residuals
  cat("\nLoading residuals..\n")
  rzdl <- alply(.data = rzd, .margins = 1, 
    .fun = function(z){ readRDS(z) },
    .progress = "text")

  rzd <- rbindlist(rzdl)
  rm(rzdl); gc()


  ## Replace cells in a raster with residuals
  cat("\nCreating raster with residuals..\n")
  rst <- readAll(rst)                # load to RAM, for faster replacement
  res <- rst
  res[ rzd$cell ] <- rzd$Residuals

  ## Predictions + Residuals === on different scale! (e.g. [-21, 112])
  cat("\nUpdating predictions..\n")
  ok <- rst + res

  ## Rescale = (x - rmin)/(rmax - rmin) * (tmax - tmin) + tmin
  cat("\nRescaling predictions..\n")
  # x    = observed value (predictions + residuals)
  # rmin = min value of range in `ok`
  # rmax = min value of range in `ok`
  # tmin = min value of observed range
  # tmax = max value of observed range

  TMIN <- minValue(rst)
  TMAX <- maxValue(rst)
  RMIN <- minValue(ok)
  RMAX <- maxValue(ok)

  RR <- (RMAX - RMIN)
  TT <- (TMAX - TMIN)

  oks <- (ok - RMIN) / RR * TT + TMIN

  ## Mask glaciated areas (snow and ice) --> change to 101
  cat("\nSnow and ice masking..\n")
  rst[ SNOW$cell ] <- 101   # raw predictions
  oks[ SNOW$cell ] <- 101   # rescaled( predictions + residuals )


  ## Function for plotting a map
  ## LT: use the same colours, but starting the blue for V2=40
  ##     use grey color for glaciated areas (ice & snow)
  plot_div <- function(rs, output, ncolors = 30, MIN = 40, MAX = 100, type = "vulnerability"){

    ## Diverging color palette
    colors <- rev( colorspace::divergingx_hcl(n = ncolors, "RdYlBu") )

    ## Vulnerability  = use custom color range, e.g. [40, 100]
    if(type %in% "vulnerability"){      
    
      ## Assign vulnerability breaks
      if(MAX == 100){ 
        colors <- c(colors, "grey80", "grey80")             ## Add grey color for glaciated areas
        BRK <- c(0, seq(MIN, MAX, l = ncolors), 101)
      }
      if(MAX < 100) {
        colors <- c(colors, colors[ ncolors ], "grey80")    ## Add grey color for glaciated areas
        BRK <- c(0, seq(MIN, MAX, l = ncolors), 100, 101)
      }
    }


    ## Residuals
    if(type %in% "residuals"){
      BRK <- NULL
    }

    pdf(file = paste0(output, ".pdf"), width = 30, height = 15, useDingbats = FALSE)
      par(oma = c(2,1,0,0) + 0.1, mar = c(0,0,1,1) + 0.1)

      ## Predictions
      plot(rs, col = colors, breaks = BRK, maxpixels = 5000000)

    dev.off()

  }

  cat("\nPloting model predictions..\n")
  plot_div(rst, output = paste0(OUTPUT, "_1.Model_Max100"), MIN = 40, MAX = 100)
  plot_div(rst, output = paste0(OUTPUT, "_1.Model_Max080"), MIN = 40, MAX = 80)

  cat("\nPloting residuals..\n")
  plot_div(res, output = paste0(OUTPUT, "_2.Residuals_interpolated"), type = "residuals")
  
  cat("\nPloting updated predictions..\n")
  plot_div(oks, output = paste0(OUTPUT, "_3.Cokriging_map_Max100"), MIN = 40, MAX = 100)
  plot_div(oks, output = paste0(OUTPUT, "_3.Cokriging_map_Max080"), MIN = 40, MAX = 80)


  ## Export rasters to tif
  cat("\nExporting residuals..\n")
  writeRaster(x = res,
    filename = paste0(OUTPUT, "_Residuals_interpolated.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=7"))

  cat("\nExporting updated predicitions..\n")
  writeRaster(x = oks,
    filename = paste0(OUTPUT, "_Cokriging_map.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=7"))

  cat("\nAll done.\n")
}


####################################


## Run main function
cokrig_maps(
  MODEL_PREDICTIONS = MODEL_PREDICTIONS, 
  INTERPOLATED_RESIDS_FLD = INTERPOLATED_RESIDS_FLD, 
  SNOW = SNOW, 
  OUTPUT = OUTPUT
  )



## Check time
end_time <- Sys.time()

tmm <- as.numeric(difftime(end_time, start_time, units = "min"))
cat("\nElapsed time: ", tmm, " minutes\n")


cat("\n")
cat("Session info:\n")
sessionInfo()
cat("\n")

