#!/usr/bin/env Rscript

## Estimate standard errors for averaged vulnerability using Burnaham and Anderson formula

## Usage:
# ./Vulnerability_script_averaging_SE.R \
#    --r1 "Agaricomycetes_NM_bio5_none_gam__Current_t2_clipped.tif" \
#    --r2 "Agaricomycetes_NM_bio17_asinh_gam__Current_t2_clipped.tif" \
#    --r3 "Agaricomycetes_NM_LUH_gam__Current_t2.tif" \
#    --output "Agaricomycetes_NM__Current_avg"


## !! NB. Land-use layer should be r3
##        it has different extent and resolution and need be rescaled


############################################## Parse input parameters

## Check time
start_time <- Sys.time()


cat("Parsing input options and arguments...\n")

suppressPackageStartupMessages(require(optparse)) # don't say "Loading required package: optparse"

## Parse arguments
option_list <- list(
  make_option(c("-1", "--r1"), action="store", default=NA, type='character', help="Input tiff file for raster 1"),
  make_option(c("-2", "--r2"), action="store", default=NA, type='character', help="Input tiff file for raster 2"),
  make_option(c("-3", "--r3"), action="store", default=NA, type='character', help="Input tiff file for raster 3"),
  make_option(c("-o", "--output"), action="store", default=NA, type='character', help="Output prefix")
)
opt <- parse_args(OptionParser(option_list=option_list))

## Validation
if(is.na(opt$r1)){
  cat("Input file 1 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$r2)){
  cat("Input file 2 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$r3)){
  cat("Input file 3 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$output)){
  cat("Output prefix is not specified.\n", file=stderr())
  stop()
}

## Assign variables
R1 <- opt$r1
R2 <- opt$r2
R3 <- opt$r3
OUTPUT <- opt$output


## Log assigned variables
cat(paste("Input file 1: ", R1, "\n", sep=""))
cat(paste("Input file 2: ", R2, "\n", sep=""))
cat(paste("Input file 3: ", R3, "\n", sep=""))
cat(paste("Output file prefix: ", OUTPUT, "\n", sep=""))
cat("\n")

############################################## Load packages

cat("Loading packages...\n")

# suppressPackageStartupMessages( library(data.table) ); cat(paste("data.table", packageVersion("data.table"), "\n"))
suppressPackageStartupMessages( library(raster) ); cat(paste("raster", packageVersion("raster"), "\n"))
cat("\n")


############################################## Main function


## Function to estimate predictor weights
wei_estimation <- function(stk, n = 200000){
  # stk = raster stack
  # n = number of points for correlation estimation

  ## Sample N points
  cat("..Sampling ", n, " points\n")
  smp <- sampleRegular(stk, size = n)

  ## Remove missing values
  smp <- na.omit(smp)
  cat("..After removal of missing values ", nrow(smp), " points remained\n")

  ## Normalize
  cat("..Normalizing variables\n")
  smp <- scale(smp, center = T, scale = T)

  ## Estimate variable weight
  cat("..Weight estimation\n")
  vv <- as.matrix(rep(1, ncol(smp)))
  # wt <- rep(1, nrow(smp))
  # Sx <- cov.wt(smp, wt = wt)[[1]]
  Sx <- cov(smp)
  weights <- solve(t(vv)%*%solve(Sx)%*%vv) %*% t(vv) %*% solve(Sx)

  ## Compositionally close weights (sum = 1)
  weights <- weights + abs(min(weights))
  weights <- weights / sum(weights)

  colnames(weights) <- names(stk)
  return(weights)
}


## Average rasters with vulnerabilities
avg_rasters_with_se <- function(stk_preds, stk_errors, output = ""){

  ########## Average of prediction estimates

  ## Simple average
  cat("Averaging rasters..\n")
  r_avg <- calc(x = stk_preds,
    fun = mean, na.rm = TRUE,
    filename = paste0(output, "_Mean.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))


  ## Spatially-uniform weights for each layer
  cat("Estimation of variable weights..\n")
  wei <- wei_estimation(stk_preds)

  cat("..R1 weight = ", wei[1], "\n")
  cat("..R2 weight = ", wei[2], "\n")
  cat("..R3 weight = ", wei[3], "\n")

  cat("Weighted averaging rasters..\n")
  r_wavg <- weighted.mean(x = stk_preds,
    w = as.vector(wei),
    na.rm = TRUE,
    filename = paste0(output, "_WeightMean.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))


  cat("Prediction averaging finished.\n")

  ########## Error averaging
  ## Use unconditional sqrt-variance, based revised formula from Burnham and Anderson (2004)

  ## Square of the standard error
  cat("Estimating square of the error..\n")
  err2 <- stk_errors^2
  
  ## Squared deviation of predictions from the average prediction (x - xavg)^2
  
  cat("Estimating ordinary squared deviation..\n")
  sqdiff_avg_1 <- (stk_preds[[1]] - r_avg)^2    # for ordinary average
  sqdiff_avg_2 <- (stk_preds[[2]] - r_avg)^2
  sqdiff_avg_3 <- (stk_preds[[3]] - r_avg)^2

  cat("Estimating weighted squared deviation..\n")
  sqdiff_wavg_1 <- (stk_preds[[1]] - r_wavg)^2  # for weighted average
  sqdiff_wavg_2 <- (stk_preds[[2]] - r_wavg)^2
  sqdiff_wavg_3 <- (stk_preds[[3]] - r_wavg)^2

  cat("Stacking ordinary errors..\n")
  err_avg_1 <- err2[[1]] + sqdiff_avg_1
  err_avg_2 <- err2[[2]] + sqdiff_avg_2
  err_avg_3 <- err2[[3]] + sqdiff_avg_3
  err_avg <- stack(err_avg_1, err_avg_2, err_avg_3)

  cat("Stacking weighted errors..\n")
  err_wavg_1 <- err2[[1]] + sqdiff_wavg_1
  err_wavg_2 <- err2[[2]] + sqdiff_wavg_2
  err_wavg_3 <- err2[[3]] + sqdiff_wavg_3
  err_wavg <- stack(err_wavg_1, err_wavg_2, err_wavg_3)

  cat("Averaging ordinary errors..\n")
  e_avg <- calc(x = err_avg, fun = mean, na.rm = TRUE)

  cat("Averaging weighted errors..\n")
  e_wavg <- weighted.mean(x = err_wavg, w = as.vector(wei), na.rm = TRUE)

  cat("Taking square root..\n")
  e_avg  <- sqrt(e_avg)
  e_wavg <- sqrt(e_wavg)

  cat("Exporting averaged errors..\n")

  writeRaster(x = e_avg,
    filename = paste0(OUTPUT, "_Mean_Error.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))

  writeRaster(x = e_wavg,
    filename = paste0(OUTPUT, "_WeightMean_Error.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))

  cat("Error averaging finished.\n")
}



## Load rasters -- take both bands (prediciton and SE) !!
cat("Loading raster 1..\n")
R1 <- stack(R1)

cat("Loading raster 2..\n")
R2 <- stack(R2)

cat("Loading raster 3..\n")
R3 <- stack(R3)


## Rescale LU-layer to the same resolution and extent
cat("Cropping raster 3 to extent...\n")
ext <- extent(c(-179, 179, -57, 80))
R3 <- crop(R3, ext)

cat("Increasing resolution of raster 3...\n")
res1 <- res(R1)[1]
res3 <- res(R3)[1]
R3r <- disaggregate(R3, fact = res3/res1)
cat("Resolution of raster 3 was ", res3, " and became ", res(R3r)[1], "\n")

## Mask land-use layer by land (using CHELSA)
cat("Masking raster 3...\n")
R3r <- mask(x = R3r, mask = R1)

## Export modified raster
cat("Exporting raster 3...\n")
writeRaster(x = R3r,
  filename = paste0(OUTPUT, "__LU_rescaled_2bands.tif"),
  format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))



## Create stack with 3 layers (bio5, bio17, and LU)
cat("Creating raster stack..\n")
STK_preds <- stack(R1[[1]], R2[[1]], R3r[[1]])
STK_errors <- stack(R1[[2]], R2[[2]], R3r[[2]])


## Run main function
cat("Run main function..\n")
avg_rasters_with_se(
  stk_preds = STK_preds,
  stk_errors = STK_errors,
  output = OUTPUT)


## Delete all the temporary files created by 'raster'
cat("Removing temp files..\n")
removeTmpFiles(h = 0.01)

## Check time
end_time <- Sys.time()

tmm <- as.numeric(difftime(end_time, start_time, units = "min"))
cat("\nElapsed time: ", tmm, " minutes\n")


cat("\n")
cat("Session info:\n")
sessionInfo()
cat("\n")

