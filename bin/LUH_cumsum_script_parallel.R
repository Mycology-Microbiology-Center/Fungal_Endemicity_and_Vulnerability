#!/usr/bin/env Rscript

## Script to estimate the cumulative sum of land cover transitions
## Input parameter = trasition name, e.g. "primf_to_secdn"
## Input data = Human footprint index based on the Land-Use Harmonisation (LUH2; Hurtt et al., 2020, doi:10.5194/gmd-13-5425-2020)
#    - historical data: transitions.nc 
#    - future predictions: multiple-transitions_input4MIPs_landState_ScenarioMIP_UofMD-MAGPIE-ssp585-2-1-f_gn_2015-2100.nc

## (NB. number of threads is hardcoded)

## Check time
start_time <- Sys.time()

suppressPackageStartupMessages(library(optparse))

## Parse arguments
option_list <- list(
  make_option(c("-i", "--input"), action="store", default=NA, type='character', help="Transition name")
)
opt <- parse_args(OptionParser(option_list=option_list))

## Assign variables
INPUT <- opt$input

cat("Loading packages...\n")
suppressPackageStartupMessages( library(raster) ); cat(paste("raster", packageVersion("raster"), "\n"))
suppressPackageStartupMessages( library(ncdf4) ); cat(paste("ncdf4", packageVersion("ncdf4"), "\n"))

cat("Loading data...\n")

## Current and past transitions
tr_cur <- "transitions.nc"

## Futute transitions
tr_fut <- "multiple-transitions_input4MIPs_landState_ScenarioMIP_UofMD-MAGPIE-ssp585-2-1-f_gn_2015-2100.nc"

stk_cur <- stack(tr_cur, varname = INPUT)
stk_fut <- stack(tr_fut, varname = INPUT)

## Concatenate present and future years
cat("Concatenating...\n")
stk <- stack(stk_cur, stk_fut)
names(stk) <- paste0("y", 850:2099)

## Starting a cluster
cat("Starting a cluster...\n")
beginCluster(20)

## Cumulative sum within each transition
cat("Cumulative sum estimation...\n")

## If there are no NA values
# stc <- cumsum(stk)

## Custom function which ignores NAs
cumsum_na <- function(x){
  x[ which(is.na(x)) ] <- 0
  return( cumsum(x) )
}

# stc <- calc(x = stk, fun = cumsum_na)  # single thread
stc <- clusterR(stk, calc, args = list(fun = cumsum_na))

## End cluster
cat("End cluster...\n")
endCluster()

## Export result
cat("Exporting...\n")
saveRDS(object = stc, file = paste0("CS__", INPUT, ".RData"), compress = "xz")
writeRaster(x = stc, filename = paste0("CS__", INPUT), format = "CDF", force_v4 = TRUE, compression = 7)

cat("All done\n")

## Check time
end_time <- Sys.time()

tmm <- as.numeric(difftime(end_time, start_time, units = "min"))
cat("\nElapsed time: ", tmm, " minutes\n")


## Collect Information About the Current R Session
cat("\n")
sessionInfo()    
