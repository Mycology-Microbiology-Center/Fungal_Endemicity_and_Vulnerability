#!/usr/bin/env Rscript

## Script for the estimation of vulnerability indices

## Usage:
# ./Vulnerability_script.R \
#    --input "Vuln_inp_data__Pathogen.RData" \
#    --env "Altitude" \
#    --transf "none"

##   --output "Opp_human_path__Altitude"


############################################## Parse input parameters

cat("Parsing input options and arguments...\n")

suppressPackageStartupMessages(require(optparse)) # don't say "Loading required package: optparse"

## Parse arguments
option_list <- list(
  make_option(c("-i", "--input"), action="store", default=NA, type='character', help="Input file name"),
  make_option(c("-e", "--env"), action="store", default=NA, type='character', help="Name of the env variable"),
  make_option(c("-t", "--transf"), action="store", default="none", type='character', help="Variable transformation")
  # , make_option(c("-o", "--output"), action="store", default=NA, type='character', help="Output file prefix")
)
opt <- parse_args(OptionParser(option_list=option_list))

if(is.na(opt$input)){
  cat("Input file is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$env)){
  cat("Environmental variable is not specified.\n", file=stderr())
  stop()
}
# if(is.na(opt$output)){
#   cat("Output file is not specified.\n", file=stderr())
#   stop()
# }


## Assign variables
INPUTFILE <- opt$input
VARNAME <- opt$env
TRANSFORM <- opt$transf
# OUTFILE <- opt$output

## Prepare output name prefix
OUTFILE <- gsub(pattern = "Vuln_inp_data__", replacement = "", x = basename(INPUTFILE))
OUTFILE <- gsub(pattern = ".RData", replacement = "", x = OUTFILE)
OUTFILE <- paste0(OUTFILE, "__", VARNAME)

## Log assigned variables
cat(paste("Input file: ", INPUTFILE, "\n", sep=""))
cat(paste("Env var: ", VARNAME, "\n", sep=""))
cat(paste("Env var transformation: ", TRANSFORM, "\n", sep=""))
cat(paste("Output file prefix: ", OUTFILE, "\n", sep=""))
cat("\n")

############################################## Load packages

cat("Loading packages...\n")
suppressPackageStartupMessages( library(data.table) ); cat(paste("data.table", packageVersion("data.table"), "\n"))
suppressPackageStartupMessages( library(vuln) ); cat(paste("vuln", packageVersion("vuln"), "\n"))
suppressPackageStartupMessages( library(ecole) ); cat(paste("ecole", packageVersion("ecole"), "\n"))
cat("\n")

set.seed(14789)

# https://github.com/phytomosaic/vuln/
# devtools::install_github('phytomosaic/vuln')
# devtools::install_github('phytomosaic/ecole')

############################################## Vulnerability indices

# t1 = 1st vulnerability index, describing the proportion of observed species which are vulnerable.
# t2 = 2nd vulnerability index, describing the community-mean percentile at the observed site.
# t3 = 3rd vulnerability index, describing the safety margin as the deviation of community-mean upper y limits from the observed y value.


## Function to estimate the vulnerability indices
est_vuln <- function(
  inp = "Vuln_inp_data__Opp_human_path.RData",
  varname = "Altitude",
  output_prefix = "Opp_human_path__Altitude",
  transformation = "none"){
    # inp = name of the file (with `dtt` list with spe & env)
    # varname = name of the env variable
    # out = filename prefix for the results

  ## Load data
  cat("Loading data: ", inp, "\n")
  dtt <- readRDS(inp)
  cat("Number of samples before filtration: ", nrow(dtt$spe), "\n")
  cat("Number of OTUs before filtration: ", ncol(dtt$spe) - 1, "\n")

  ## Check the varialbe
  if(!varname %in% colnames(dtt$env)){
    stop("Error: Environmental varialbe is missing in sample data.\n")
  }

  ## If there are any NAs in env variable - subset samples
  NAS <- is.na( dtt$env[[ varname ]] )
  if(any(NAS)){
    cat("Number of samples with missing metadata: ", sum(NAS), "\n")

    dtt$spe <- dtt$spe[ -which(NAS) ]
    dtt$env <- dtt$env[ -which(NAS) ]

    # any(! dtt$spe$Sample == dtt$env$SampleID_Endemism )
  }

  ## Remove sample IDs and convert to data.frame
  dtt$spe[, Sample := NULL ]

  ## Remove zero-species
  otusums <- colSums(dtt$spe)
  if(any(otusums < 1)){
    cat("Number of zero OTUs: ", sum(otusums < 1), "\n")
    missotus <- names( otusums[otusums < 1] )
    dtt$spe[, (missotus) := NULL]
  }

  cat("Number of samples after filtration: ", nrow(dtt$spe), "\n")
  cat("Number of OTUs after filtration: ", ncol(dtt$spe), "\n")

  if(!nrow(dtt$env) > 0){
    stop("Error: no data to analise.\n")
  }

  setDF(dtt$spe)
  setDF(dtt$env)


  ## Add positive constant to Altitude
  ## if there are negative values, log is not defined
  if(varname == "Altitude"){
    min_alt <- min(dtt$env[[ varname ]])
    if(min_alt < 0){ 
    cat("..Constant was added to Altitude: ", min_alt, "\n")
    dtt$env[[ varname ]] <- dtt$env[[ varname ]] + min_alt
    }
  }

  ### Transform env variable
  if(!transformation %in% "none"){
    cat("..Transforming variable with ", transformation, "\n")
  
  tmp <- dtt$env[[ varname ]]
  if(transformation == "log"){ tmp <- log1p(tmp) }
  if(transformation == "symlog"){ tmp <- sign(tmp) * log1p(abs(tmp)) }
  if(transformation == "asinh"){ tmp <- -1 * asinh(tmp) }
  if(transformation == "inv"){ tmp <- -1 * tmp }
  if(transformation == "symsqrt"){ tmp <- sign(tmp) * sqrt(abs(tmp)) }

  dtt$env[[ varname ]] <- tmp
  rm(tmp)

  } # end of transformation

  ## Add transformation name to prefix
  output_prefix <- paste0(output_prefix, "__", transformation)

  ## Estimate vulnerability index
  cat("Estimating vulnerability indices\n")
  res <- vuln(dtt$spe, y = dtt$env[[ varname ]] )

  attr(res, which = "env") <- dtt$env
  attr(res, which = "fun_group") <- attr(dtt, which = "fun_group")
  attr(res, which = "env_var") <- varname
  attr(res, which = "transformation") <- transformation

  ## Extract indices values
  extract_vuln_ind <- function(v){
    data.frame(t1 = gv(v, 1), t2 = gv(v, 2), t3 = gv(v, 3))
  }

  cat("Preparing results\n")
  inds <- data.frame(
    dtt$env[ , c("SampleID_Endemism", "Ecoregion", "Long", "Lat")],
    Variable = varname,
    EnvValue = dtt$env[ , varname],
    Funct_group = attr(dtt, which = "fun_group"),
    extract_vuln_ind(res)
    )

  ## Save results
  cat("Saving results to ", output_prefix, "\n")
  saveRDS(object = res,
    file = paste0("Vuln__", output_prefix, ".RData"),
    compress = "xz")

  saveRDS(object = inds,
    file = paste0("Inds__", output_prefix, ".RData"),
    compress = "xz")

  cat("Analysis finished\n")
  cat("Functional group: ", attr(dtt, which = "fun_group"), "\n")
  cat("Environmental varialbe:", varname, "\n")
  cat("Date: ", format(Sys.time(), "%y%m%d_%H%M%S"), "\n")
}


## Perform the analysis
est_vuln(
  inp = INPUTFILE,
  varname = VARNAME,
  out = OUTFILE,
  transformation = TRANSFORM)

cat("\n")
cat("Session info:\n")
sessionInfo()
cat("\n")


