#!/usr/bin/env Rscript

## Estimate and plot average vulnerability

## Usage:
# ./Vulnerability_script_averaging_cokrig.R \
#    --r1 "Agaricomycetes_NM_bio5_none_gam__Current_t2_clipped.tif" \
#    --r2 "Agaricomycetes_NM_bio17_asinh_gam__Current_t2_clipped.tif" \
#    --r3 "Agaricomycetes_NM_LUH_gam__Current_t2.tif" \
#    --snow "Copernicus_SnowIce.RData" \
#    --output "Agaricomycetes_NM__Current_avg"


############################################## Parse input parameters

## Check time
start_time <- Sys.time()


cat("Parsing input options and arguments...\n")

suppressPackageStartupMessages(require(optparse)) # don't say "Loading required package: optparse"

## Parse arguments
option_list <- list(
  make_option(c("-1", "--r1"), action="store", default=NA, type='character', help="Input tiff file for raster 1"),
  make_option(c("-2", "--r2"), action="store", default=NA, type='character', help="Input tiff file for raster 2"),
  make_option(c("-3", "--r3"), action="store", default=NA, type='character', help="Input tiff file for raster 3"),
  make_option(c("-s", "--snow"), action="store", default="Copernicus_SnowIce.RData", type='character', help="Data.table with ice and snow mask"),
  make_option(c("-o", "--output"), action="store", default=NA, type='character', help="Output prefix")
)
opt <- parse_args(OptionParser(option_list=option_list))

## Validation
if(is.na(opt$r1)){
  cat("Input file 1 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$r2)){
  cat("Input file 2 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$r3)){
  cat("Input file 3 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$output)){
  cat("Output prefix is not specified.\n", file=stderr())
  stop()
}

## Assign variables
R1 <- opt$r1
R2 <- opt$r2
R3 <- opt$r3
SNOW <- opt$snow
OUTPUT <- opt$output


## Log assigned variables
cat(paste("Input file 1: ", R1, "\n", sep=""))
cat(paste("Input file 2: ", R2, "\n", sep=""))
cat(paste("Input file 3: ", R3, "\n", sep=""))
cat(paste("File with snow mask: ", SNOW, "\n", sep=""))
cat(paste("Output file prefix: ", OUTPUT, "\n", sep=""))
cat("\n")

############################################## Load packages and data

cat("Loading packages...\n")

load_pckg <- function(pkg = "raster"){
  suppressPackageStartupMessages( library(package = pkg, character.only = TRUE) )
  cat(paste(pkg, packageVersion(pkg), "\n"))
}

load_pckg("data.table")
load_pckg("sp")
load_pckg("raster")
load_pckg("plyr")
load_pckg("colorspace")


cat("\n")

## Load snow and ice mask
cat("\nLoading snow mask..\n")
SNOW <- readRDS(SNOW)


############################################## Main workflow

## Function to plot vulnerability (takes into account 101 as ice)
plot_div <- function(rs, output, ncolors = 30, MIN = 40, MAX = 100){

  ## Diverging color palette
  colors <- rev( colorspace::divergingx_hcl(n = ncolors, "RdYlBu") )

  ## Assign vulnerability breaks
  if(MAX == 100){ 
    colors <- c(colors, "grey80", "grey80")             ## Add grey color for glaciated areas
    BRK <- c(0, seq(MIN, MAX, l = ncolors), 101)
  }
  if(MAX < 100) {
    colors <- c(colors, colors[ ncolors ], "grey80")    ## Add grey color for glaciated areas
    BRK <- c(0, seq(MIN, MAX, l = ncolors), 100, 101)
  }

  pdf(file = output, width = 30, height = 15, useDingbats = FALSE)
    par(oma = c(2,1,0,0) + 0.1, mar = c(0,0,1,1) + 0.1)

    ## Predictions
    plot(rs, col = colors, breaks = BRK, maxpixels = 5000000)

  dev.off()
}


## Load rasters (take only first band)
cat("Loading raster 1..\n")
R1 <- raster(R1)

cat("Loading raster 2..\n")
R2 <- raster(R2)

cat("Loading raster 3..\n")
R3 <- raster(R3)


## Create stack with 3 layers (bio5, bio17, and LU)
cat("Creating raster stack..\n")
STK <- stack(R1, R2, R3)


## Run main function
cat("Averaging rasters..\n")
r_avg <- calc(x = STK,
  fun = mean, na.rm = TRUE)

## Mask glaciated areas (snow and ice) --> change to 101
cat("Snow and ice masking..\n")
r_avg[ SNOW$cell ] <- 101


cat("Plotting the map..\n")
plot_div(r_avg, output = paste0(OUTPUT, "_Max100.pdf"), MIN = 40, MAX = 100)
plot_div(r_avg, output = paste0(OUTPUT, "_Max080.pdf"), MIN = 40, MAX = 80)

cat("Exporting averaged raster\n")
writeRaster(x = r_avg,
  filename = paste0(OUTPUT, ".tif"),
  format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=7"))



## Delete all the temporary files created by 'raster'
cat("Removing temp files..\n")
removeTmpFiles(h = 0.01)

## Check time
end_time <- Sys.time()

tmm <- as.numeric(difftime(end_time, start_time, units = "min"))
cat("\nElapsed time: ", tmm, " minutes\n")


cat("\n")
cat("Session info:\n")
sessionInfo()
cat("\n")

