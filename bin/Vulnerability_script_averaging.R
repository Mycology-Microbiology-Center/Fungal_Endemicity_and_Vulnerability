#!/usr/bin/env Rscript

## Estimate average vulnerability (ordinary and correlation-weigthed)

## Usage:
# ./Vulnerability_script_averaging.R \
#    --r1 "Agaricomycetes_NM_bio5_none_gam__Current_t2_clipped.tif" \
#    --r2 "Agaricomycetes_NM_bio17_asinh_gam__Current_t2_clipped.tif" \
#    --r3 "Agaricomycetes_NM_LUH_gam__Current_t2.tif" \
#    --output "Agaricomycetes_NM__Current_avg"


## !! NB. Land-use layer should be r3
##        it has different extent and resolution and need be rescaled


############################################## Parse input parameters

## Check time
start_time <- Sys.time()


cat("Parsing input options and arguments...\n")

suppressPackageStartupMessages(require(optparse)) # don't say "Loading required package: optparse"

## Parse arguments
option_list <- list(
  make_option(c("-1", "--r1"), action="store", default=NA, type='character', help="Input tiff file for raster 1"),
  make_option(c("-2", "--r2"), action="store", default=NA, type='character', help="Input tiff file for raster 2"),
  make_option(c("-3", "--r3"), action="store", default=NA, type='character', help="Input tiff file for raster 3"),
  make_option(c("-o", "--output"), action="store", default=NA, type='character', help="Output prefix")
)
opt <- parse_args(OptionParser(option_list=option_list))

## Validation
if(is.na(opt$r1)){
  cat("Input file 1 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$r2)){
  cat("Input file 2 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$r3)){
  cat("Input file 3 is not specified.\n", file=stderr())
  stop()
}
if(is.na(opt$output)){
  cat("Output prefix is not specified.\n", file=stderr())
  stop()
}

## Assign variables
R1 <- opt$r1
R2 <- opt$r2
R3 <- opt$r3
OUTPUT <- opt$output


## Log assigned variables
cat(paste("Input file 1: ", R1, "\n", sep=""))
cat(paste("Input file 2: ", R2, "\n", sep=""))
cat(paste("Input file 3: ", R3, "\n", sep=""))
cat(paste("Output file prefix: ", OUTPUT, "\n", sep=""))
cat("\n")

############################################## Load packages

cat("Loading packages...\n")

# suppressPackageStartupMessages( library(data.table) ); cat(paste("data.table", packageVersion("data.table"), "\n"))
suppressPackageStartupMessages( library(raster) ); cat(paste("raster", packageVersion("raster"), "\n"))
cat("\n")


############################################## Main function


## Function to estimate predictor weights
wei_estimation <- function(stk, n = 200000){
  # stk = raster stack
  # n = number of points for correlation estimation

  ## Sample N points
  cat("..Sampling ", n, " points\n")
  smp <- sampleRegular(stk, size = n)

  ## Remove missing values
  smp <- na.omit(smp)
  cat("..After removal of missing values ", nrow(smp), " points remained\n")

  ## Normalize
  cat("..Normalizing variables\n")
  smp <- scale(smp, center = T, scale = T)

  ## Estimate variable weight
  cat("..Weight estimation\n")
  vv <- as.matrix(rep(1, ncol(smp)))
  # wt <- rep(1, nrow(smp))
  # Sx <- cov.wt(smp, wt = wt)[[1]]
  Sx <- cov(smp)
  weights <- solve(t(vv)%*%solve(Sx)%*%vv) %*% t(vv) %*% solve(Sx)

  ## Compositionally close weights (sum = 1)
  weights <- weights + abs(min(weights))
  weights <- weights / sum(weights)

  colnames(weights) <- names(stk)
  return(weights)
}


## Average rasters with vulnerabilities
avg_rasters <- function(stk, output = ""){

  ## Simple average
  cat("Averaging rasters..\n")
  r_avg <- calc(x = stk,
    fun = mean, na.rm = TRUE,
    filename = paste0(output, "_Mean.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))


  ## Spatially-uniform weights for each layer
  cat("Estimation of variable weights..\n")
  wei <- wei_estimation(stk)

  cat("..R1 weight = ", wei[1], "\n")
  cat("..R2 weight = ", wei[2], "\n")
  cat("..R3 weight = ", wei[3], "\n")

  cat("Weighted averaging rasters..\n")
  r_wavg <- weighted.mean(x = stk,
    w = as.vector(wei),
    na.rm = TRUE,
    filename = paste0(output, "_WeightMean.tif"),
    format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))

  cat("Averaging finished.\n")
}



## Load rasters (take only first band)
cat("Loading raster 1..\n")
R1 <- raster(R1)

cat("Loading raster 2..\n")
R2 <- raster(R2)

cat("Loading raster 3..\n")
R3 <- raster(R3)


## Rescale LU-layer to the same resolution and extent
cat("Cropping raster 3 to extent...\n")
ext <- extent(c(-179, 179, -57, 80))
R3 <- crop(R3, ext)

cat("Increasing resolution of raster 3...\n")
res1 <- res(R1)[1]
res3 <- res(R3)[1]
R3r <- disaggregate(R3, fact = res3/res1)
cat("Resolution of raster 3 was ", res3, " and became ", res(R3r)[1], "\n")

## Mask land-use layer by land (using CHELSA)
cat("Masking raster 3...\n")
R3r <- mask(x = R3r, mask = R1)

## Export modified raster
cat("Exporting raster 3...\n")
writeRaster(x = R3r,
  filename = paste0(OUTPUT, "__LU_rescaled.tif"),
  format = "GTiff", options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=6"))



## Create stack with 3 layers (bio5, bio17, and LU)
cat("Creating raster stack..\n")
STK <- stack(R1, R2, R3r)


## Run main function
cat("Run main function..\n")
avg_rasters(stk = STK, output = OUTPUT)


## Delete all the temporary files created by 'raster'
cat("Removing temp files..\n")
removeTmpFiles(h = 0.01)

## Check time
end_time <- Sys.time()

tmm <- as.numeric(difftime(end_time, start_time, units = "min"))
cat("\nElapsed time: ", tmm, " minutes\n")


cat("\n")
cat("Session info:\n")
sessionInfo()
cat("\n")

